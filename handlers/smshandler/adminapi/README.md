# SMS handler admin API for mongoDB

This is an admin tool for managing the smshandler users database.

## Run the API backend

`CSP_MONGODB_URL="<mongo_url_string>" CSP_DATABASE=users go run . --logLevel=debug --port=5001`

## API methods

The API requires a bearer authentication token, if not provided by the user the token is autogenerated.
The following examples with `curl` include an implicit header flag such as:

`curl -H "Authorization: Bearer 63d97da8-86e7-4313-92e7-2d8ae99e6c6e" <query>`


### 1. dump the database
Dump all users and elections (JSON).
Note that this method can be quite heavy and reach HTTP body size limit if the database is too big.
Only suitable for debug purposes.

```json
curl http://127.0.0.1:5001/smsapi/dump

<JSON response here>
```

### 2. list user
List all users identifiers (userID).

```json
curl http://127.0.0.1:5001/smsapi/users

{
 "users": [
  "6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac",
  "bf5b6a9c69a5abee870b3667e92c589ef9c13458be0fc0493b2ba5a9658c690b",
  "87b1161ad7a5290dd1d2b4b8ded948950d7420551648000887fb2529be58a39e"
 ]
}
```

### 3. get user data
Retrieve the user data by its userID.

```json
curl http://127.0.0.1:5001/smsapi/user/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac

{
 "userID": "6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac",
 "elections": [
  {
   "electionId": "1111111111111111111111111111111111111111111111111111111111111111",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "2222222222222222222222222222222222222222222222222222222222222222",
   "remainingAttempts": 3,
   "consumed": false
  },
  {
   "electionId": "3333333333333333333333333333333333333333333333333333333333333333",
   "remainingAttempts": 5,
   "consumed": true
  }
 ],
 "extraData": "John 16/05/1984",
 "phone": {
  "country_code": 34,
  "national_number": 66778899
 }
}
```

### 4. add SMS attempt
Increase by 1 the number of remaning SMS authentication attempts for a user and an election.

```json
curl http://127.0.0.1:5001/smsapi/addAttempt/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac/2222222222222222222222222222222222222222222222222222222222222222

{"ok":"true"}
```

### 5. set consumed
The consumed bool determines if the user has already fetch the CSP proof.

```json
curl http://127.0.0.1:5001/smsapi/setConsumed/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac/2222222222222222222222222222222222222222222222222222222222222222/true

{"ok":"true"}
```

After the two previous operations, the user looks like this:

```json
curl http://127.0.0.1:5001/smsapi/user/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac

{
 "userID": "6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac",
 "elections": [
  {
   "electionId": "1111111111111111111111111111111111111111111111111111111111111111",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "2222222222222222222222222222222222222222222222222222222222222222",
   "remainingAttempts": 6,
   "consumed": true
  },
  {
   "electionId": "3333333333333333333333333333333333333333333333333333333333333333",
   "remainingAttempts": 5,
   "consumed": false
  }
 ],
 "extraData": "John 16/05/1984",
 "phone": {
  "country_code": 34,
  "national_number": 66778899
 }
}
```

### 6. clone user
Make a copy of a user with a new userID. The list of elections is preserved but not its internal status (consumed or tokens).
The first URL parameter is the source userID and the second the new userID.

```json
curl http://127.0.0.1:5001/smsapi/cloneUser/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac/b3deea91021d8c3dd6b52b2b1ba5defbe4b0b2fe03bc4ad6944148effb3e1222

{"ok":"true"}
```

The status of the user after the previous command is:

```json 
curl http://127.0.0.1:5001/smsapi/user/b3deea91021d8c3dd6b52b2b1ba5defbe4b0b2fe03bc4ad6944148effb3e1222

{
 "userID": "b3deea91021d8c3dd6b52b2b1ba5defbe4b0b2fe03bc4ad6944148effb3e1222",
 "elections": [
  {
   "electionId": "1111111111111111111111111111111111111111111111111111111111111111",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "2222222222222222222222222222222222222222222222222222222222222222",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "3333333333333333333333333333333333333333333333333333333333333333",
   "remainingAttempts": 5,
   "consumed": false
  }
 ],
 "extraData": "John 16/05/1984",
 "phone": {
  "country_code": 34,
  "national_number": 66778899
 }
}
```

### 7. add a new user
Creates a new user with a `phone` and an arbitrary `extra` field for storing personal information.

```json
curl http://127.0.0.1:5001/smsapi/newUser/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4 -d '{"phone":"+34700605040","extra":"Alice 02/04/1991"}' -X POST

{"ok":"true"}
```

Then we can query the new user.

```json
curl http://127.0.0.1:5001/smsapi/user/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4`

{
 "userID": "ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4",
 "extraData": "Alice 02/04/1991",
 "phone": {
  "country_code": 34,
  "national_number": 700605040
 }
}
```

### 8. add an election
Adds a new election for a user.

```json
curl http://127.0.0.1:5001/smsapi/addElection/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4/3333333333333333333333333333333333333333333333333333333333333333

{"ok":"true"}
```

The new user now has the previous election configured:

```json
curl http://127.0.0.1:5001/smsapi/user/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4
{
 "userID": "ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4",
 "elections": [
  {
   "electionId": "",
   "remainingAttempts": 5,
   "consumed": false
  }
 ],
 "extraData": "Alice 02/04/1991",
 "phone": {
  "country_code": 34,
  "national_number": 700605040
 }
}
```

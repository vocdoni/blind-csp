# SMS handler admin API for mongoDB

This is an admin tool for managing the smshandler users database.

## Run the API backend

`CSP_MONGODB_URL="<mongo_url_string>" CSP_DATABASE=users go run . --logLevel=debug --port=5001`

## API methods

The API requires a bearer authentication token, if not provided by the user the token is autogenerated.
The following examples with `curl` include an implicit header flag such as:

`curl -H "Authorization: Bearer 63d97da8-86e7-4313-92e7-2d8ae99e6c6e" <query>`


### 1. Database dump
Dump all users and elections (JSON).
Note that this method can be quite heavy and reach HTTP body size limit if the database is too big.
Only suitable for debug purposes.

- Request
```bash
curl http://127.0.0.1:5001/smsapi/dump
```
- Response OK
```json
{
 "userID": "6d2347cf59313bdb4038f0c6643e9289d694c1c67d4d1d66f56968e374d48669",
 "elections": [
  {
   "electionId": "1111111111111111111111111111111111111111111111111111111111111111",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "2222222222222222222222222222222222222222222222222222222222222222",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "3333333333333333333333333333333333333333333333333333333333333333",
   "remainingAttempts": 5,
   "consumed": false
  }
 ],
 "extraData": "Vocdoni",
 "phone": {
  "country_code": 34,
  "national_number": 651200042
 }
}
```
- Response Error
```json
{
    "error": "auth token not valid"
}
```

### 2. List users
List all users identifiers (userID).

- Request
```bash
curl http://127.0.0.1:5001/smsapi/users 
```
- Response OK
```json
{
 "users": [
  "6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac",
  "bf5b6a9c69a5abee870b3667e92c589ef9c13458be0fc0493b2ba5a9658c690b",
  "87b1161ad7a5290dd1d2b4b8ded948950d7420551648000887fb2529be58a39e"
 ]
}
```
- Response Error
```json
{
    "error": "auth token not valid"
}
```

### 3. Get user data
Retrieve the user data given a userID.

- Request
```bash
curl http://127.0.0.1:5001/smsapi/user/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac
```
- Response OK
```json
{
 "userID": "6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac",
 "elections": [
  {
   "electionId": "1111111111111111111111111111111111111111111111111111111111111111",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "2222222222222222222222222222222222222222222222222222222222222222",
   "remainingAttempts": 3,
   "consumed": false
  },
  {
   "electionId": "3333333333333333333333333333333333333333333333333333333333333333",
   "remainingAttempts": 5,
   "consumed": true
  }
 ],
 "extraData": "John 16/05/1984",
 "phone": {
  "country_code": 34,
  "national_number": 66778899
 }
}
```
- Response Error
```json
{
    "error": "user is unknown"
}
```

### 4. Add SMS attempt
Increase by 1 the number of remaning SMS authentication attempts for a given userID and a given electionID.

- Request
```bash
# .../addAttempt/<userID>/<electionID>
curl http://127.0.0.1:5001/smsapi/addAttempt/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac/2222222222222222222222222222222222222222222222222222222222222222
```
- Response OK
```json
{
    "ok":"true"
}
```
- Response Error 
```json
{
    "error": "user does not belong to election"
}
```

### 5. Set consumed
The consumed bool indicates if a user represented by its userID has already fetched a CSP proof for a given electionId.

- Request
```bash
curl http://127.0.0.1:5001/smsapi/setConsumed/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac/2222222222222222222222222222222222222222222222222222222222222222/true
```
- Response OK
```json
{
    "ok": "true"
}
```
- Response Error
```json
{
    "error":
}
```

After the two previous operations, the user looks like this:

```bash
curl http://127.0.0.1:5001/smsapi/user/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac
```
```json
{
 "userID": "6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac",
 "elections": [
  {
   "electionId": "1111111111111111111111111111111111111111111111111111111111111111",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "2222222222222222222222222222222222222222222222222222222222222222",
   "remainingAttempts": 6,
   "consumed": true
  },
  {
   "electionId": "3333333333333333333333333333333333333333333333333333333333333333",
   "remainingAttempts": 5,
   "consumed": false
  }
 ],
 "extraData": "John 16/05/1984",
 "phone": {
  "country_code": 34,
  "national_number": 66778899
 }
}
```

### 6. Clone user
Make a copy of a user with a new userID. The list of elections is preserved but not its internal status (consumed or remainingAttempts).
The first URL parameter is the source userID and the second the new userID.

- Request
```bash
curl http://127.0.0.1:5001/smsapi/cloneUser/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac/b3deea91021d8c3dd6b52b2b1ba5defbe4b0b2fe03bc4ad6944148effb3e1222
```
- Response OK
```json
{
    "ok": "true"
}
```
- Response Error
```json
{
    "error": "user already exists"
}
```

The status of the user after the previous command is:

```bash
curl http://127.0.0.1:5001/smsapi/user/b3deea91021d8c3dd6b52b2b1ba5defbe4b0b2fe03bc4ad6944148effb3e1222
```
```json
{
 "userID": "b3deea91021d8c3dd6b52b2b1ba5defbe4b0b2fe03bc4ad6944148effb3e1222",
 "elections": [
  {
   "electionId": "1111111111111111111111111111111111111111111111111111111111111111",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "2222222222222222222222222222222222222222222222222222222222222222",
   "remainingAttempts": 5,
   "consumed": false
  },
  {
   "electionId": "3333333333333333333333333333333333333333333333333333333333333333",
   "remainingAttempts": 5,
   "consumed": false
  }
 ],
 "extraData": "John 16/05/1984",
 "phone": {
  "country_code": 34,
  "national_number": 66778899
 }
}
```

### 7. Add a new user
Creates a new user with a `phone` and an `extra` field containing arbitrary data.

- Request
```bash
curl http://127.0.0.1:5001/smsapi/newUser/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4 -d '{"phone":"+34700605040","extra":"Alice 02/04/1991"}' -X POST
```
- Response OK
```json
{
    "ok": "true"
}
```
- Response Error
```json
{
    "error": "user already exists"
}
```
Then we can query the new user:
```bash
curl http://127.0.0.1:5001/smsapi/user/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4`
```
```json
{
 "userID": "ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4",
 "extraData": "Alice 02/04/1991",
 "phone": {
  "country_code": 34,
  "national_number": 700605040
 }
}
```

### 8. Add an election
Adds a new election for a given user.

- Request
```bash
curl http://127.0.0.1:5001/smsapi/addElection/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4/3333333333333333333333333333333333333333333333333333333333333333
```
- Response OK
```json
{
    "ok": "true"
}
```
- Response Error
```json
{
    "error": "user is unknown"
}
```

Now the new user has the previous election configured:

```bash
curl http://127.0.0.1:5001/smsapi/user/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4
```
```json
{
 "userID": "ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4",
 "elections": [
  {
   "electionId": "3333333333333333333333333333333333333333333333333333333333333333",
   "remainingAttempts": 5,
   "consumed": false
  }
 ],
 "extraData": "Alice 02/04/1991",
 "phone": {
  "country_code": 34,
  "national_number": 700605040
 }
}
```
### 9. Search term on extraData field

The `extraData` field can store any arbitrary data regarding the user (full name, national ID, birth date, etc.).
The search endpoint returns the list of userID for a specific term contained inside the extraData field.
The search text function matches full words, such as "Alice" but not "Ali".

```bash
curl  http://127.0.0.1:5001/smsapi/search -d '{"term":"Alice"}' -X POST
```
```json
{
 "users": ["ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4"]
}
```

### 10. Delete a user
A user can be deleted by its userID.

```bash
curl http://127.0.0.1:5001/smsapi/delUser/ff29acb484cc721c102715295af1698ff90e90cb1b70f4d05aaa19674dbddce4
```
` Response OK
```json
{
    "ok": "true"
}
```
- Response Error
```json
{
    "error": "user is unknown"
}
```
### 11. Import
Import can be used to insert (or update) the database using the output from a dump.

```bash
curl http://127.0.0.1:5001/smsapi/dump > dump.json
```

```bash
curl http://127.0.0.1:5001/smsapi/import -d @dump.json
```
` Response OK
```json
{
    "ok": "true"
}
```
- Response Error
```json
{
    "error": "error goes here"
}
```

### 12. Set user data
Modifies the existing user fields `phone` and `extra` by using the following POST call.


- Request
```bash
curl http://127.0.0.1:5001/smsapi/setUserData/6c0b6e1020b6354c714fc65aa198eb95e663f038e32026671c58677e0e0f8eac -d '{"phone":"+34722847182", "extra":"John Smith"}'
```
- Response OK
```json
{
    "ok": "true"
}
```
- Response Error
```json
{
    "error": "error goes here"
}
```
